# Soft-Start Configuration Guide

## ภาพรวม
ระบบ Soft-Start ถูกเพิ่มใน `main/src/motors.c` เพื่อลด inrush current และ voltage sag ตอนสตาร์ทมอเตอร์ ซึ่งช่วยให้แบตเตอร์รี 3C (27Ah) สามารถจ่ายกระแสได้อย่างมีประสิทธิภาพมากขึ้น

## การตั้งค่า (อยู่ใน `main/src/motors.c`)

```c
#define SOFT_START_ENABLED 1        // เปิด/ปิด soft-start (1=เปิด, 0=ปิด)
#define RAMP_STEP_SIZE 50           // ขั้นของการเพิ่ม duty แต่ละครั้ง
#define RAMP_DELAY_MS 3             // ดีเลย์ระหว่าง step (ms)
```

## พารามิเตอร์

### `SOFT_START_ENABLED`
- **1** = เปิดใช้งาน soft-start (แนะนำสำหรับแบต 3C)
- **0** = ปิดใช้งาน (กลับไปใช้วิธีเดิม - กระโดดทันที)

### `RAMP_STEP_SIZE`
ขั้นของการเพิ่มลด PWM duty แต่ละครั้ง (ค่าจาก 0-1023)

- **ค่าเล็ก (10-30)**: นุ่มนวลมาก, ใช้เวลานานขึ้น, ลด inrush มากที่สุด
- **ค่ากลาง (50-100)**: สมดุลระหว่างความนุ่มนวลและความเร็ว **(แนะนำ)**
- **ค่าใหญ่ (150-300)**: เร็วแต่ลด inrush น้อยลง

### `RAMP_DELAY_MS`
เวลารอระหว่างแต่ละ step (มิลลิวินาที)

- **1-2 ms**: รวดเร็ว, การตอบสนองดี, ลด inrush ปานกลาง
- **3-5 ms**: สมดุล **(แนะนำ)**
- **10+ ms**: ช้ามาก, การตอบสนองล่าช้า, ลด inrush สูงสุด

## ตัวอย่างการคำนวณ

สมมติ `RAMP_STEP_SIZE = 50` และ `RAMP_DELAY_MS = 3`:

**กรณีที่ 1: เริ่มจากหยุด (0) ไป full speed (1023)**
- จำนวน steps = 1023 / 50 ≈ 21 steps
- เวลาทั้งหมด = 21 × 3ms = **63 ms**

**กรณีที่ 2: เริ่มจากหยุด (0) ไป 40% (409)**
- จำนวน steps = 409 / 50 ≈ 9 steps
- เวลาทั้งหมด = 9 × 3ms = **27 ms**

**กรณีที่ 3: หยุด (จาก duty ใด ๆ ไป 0)**
- ใช้ `RAMP_STEP_SIZE × 2` = 100 เพื่อหยุดเร็วขึ้น
- ลดปัญหามอเตอร์หมุนต่อเนื่องนานเกินไป

## การปรับแต่งตามกรณีใช้งาน

### สำหรับแบต 3C ที่มี BMS จำกัดกระแส:
```c
#define RAMP_STEP_SIZE 40
#define RAMP_DELAY_MS 4
```
→ เพิ่มเวลา ramp เพื่อลด peak current

### สำหรับมอเตอร์ขนาดเล็ก/แบตแข็งแรง:
```c
#define RAMP_STEP_SIZE 100
#define RAMP_DELAY_MS 2
```
→ รวดเร็วขึ้น, responsiveness ดีขึ้น

### สำหรับการแข่งขัน/ต้องการตอบสนองทันที:
```c
#define SOFT_START_ENABLED 0
```
→ ปิดใช้งาน soft-start (แต่เสี่ยง voltage sag)

## ผลลัพธ์ที่คาดหวัง

✅ **ลด voltage sag** เมื่อสตาร์ทมอเตอร์  
✅ **ป้องกัน BMS cutoff** จากกระแส spike  
✅ **มอเตอร์ทำงานนุ่มนวลขึ้น** (ลดกระตุก)  
✅ **อายุการใช้งานแบตดีขึ้น** (ลด stress)  
⚠️ **เวลาตอบสนองช้าลงเล็กน้อย** (~30-100ms ขึ้นอยู่กับการตั้งค่า)

## การ Debug

เพิ่ม log ใน `motors_set_speed()` เพื่อดูการทำงาน:

```c
ESP_LOGI(TAG, "Motor %d: %d → %d (ramping)", motor_id, current, target);
```

## หมายเหตุสำคัญ

1. **Shared PWM pins**: มอเตอร์ 0+1 และ 2+3 ใช้ PWM ร่วมกัน - การ ramp จะส่งผลต่อทั้งคู่พร้อมกัน
2. **TB6612FNG limits**: ไดร์เวอร์มี current limit ~1.2A ต่อเนื่อง, 3.2A peak - ถ้ามอเตอร์ดึงเกินอาจร้อนหรือ shutdown
3. **การตอบสนอง Joystick**: ถ้ารู้สึกว่าควบคุมช้า ให้ลด `RAMP_DELAY_MS` หรือเพิ่ม `RAMP_STEP_SIZE`
4. **Stop behavior**: การหยุดใช้ step size เป็น 2 เท่า (double) เพื่อเบรกเร็วขึ้น

## Hardware Recommendations

เพิ่มประสิทธิภาพเพิ่มเติม:
- เพิ่ม electrolytic capacitor 470-2200µF (low ESR) ใกล้ตัว TB6612FNG
- ตรวจสอบสายไฟให้มีขนาดเพียงพอ (AWG 16-18 ขึ้นไป)
- ตรวจสอบ BMS ว่ารองรับกระแส burst (แม้จะเป็น 3C)
